<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Best Cement IT Asset Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .required-label::after { content: '*'; color: red; margin-left: 2px; }
        .stat-card {
            background-color: #f9fafb; border: 1px solid #e5e7eb;
            border-radius: 0.75rem; padding: 1rem; text-align: center;
            transition: all 0.2s ease-in-out;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5; border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* * ===============================================
         * NEW AGGRESSIVE PRINT STYLES (To fix blank page)
         * ===============================================
         */
        @media print {
            /* Hide ALL direct children of body by default */
            body > * {
                display: none !important;
                visibility: hidden !important;
            }

            /* Un-hide ONLY the print modal */
            #print-modal {
                display: block !important;
                visibility: visible !important;
                position: static !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Hide the non-printable parts inside the modal */
            #print-modal .fixed.inset-0, /* The background overlay */
            #print-modal .hidden.sm\:inline-block, /* The centering span */
            #print-modal-buttons {
                display: none !important;
                visibility: hidden !important;
            }

            /* Reset body and html */
            body, html {
                background: #fff !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Force the modal content and form to be static blocks */
            #print-modal-content, #printable-handover-form {
                display: block !important;
                visibility: visible !important;
                position: static !important;
                width: auto !important;
                max-width: 100% !important;
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }

            /* Add back the print margin ONLY to the form itself */
            #printable-handover-form {
                padding: 1cm !important;
            }

            /* Ensure text is black */
            #printable-handover-form, #printable-handover-form * {
                color: #000 !important;
                visibility: visible !important;
            }

            .print-avoid-break {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Main Application Container --><div id="app" class="flex flex-col min-h-screen">

        <!-- Login View --><div id="login-view" class="flex-grow flex items-center justify-center p-6">
            <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl w-full max-w-md">
                <div class="text-center mb-8">
                    <!-- LOGO on Login Screen -->
                    <img src="logo.png" alt="Best Cement Logo" class="w-24 h-24 mx-auto mb-4">
                    <h1 class="text-3xl font-bold text-gray-800 mt-4">Best Cement IT Asset Management App</h1>
                    <p class="text-gray-500">Please sign in to continue</p>
                </div>
                
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                            <input type="text" id="username" class="form-input w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., admin">
                        </div>
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-lock text-gray-400"></i>
                            </div>
                            <input type="password" id="password" class="form-input w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., admin@123">
                        </div>
                    </div>
                    
                    <div id="login-error" class="text-red-500 text-sm hidden"></div>

                    <button type="submit" id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5 flex items-center justify-center">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        <span id="login-button-text">Sign In</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View (Hidden by default) --><div id="main-view" class="hidden flex-grow flex flex-col">
            
            <!-- Header/Navbar --><header class="bg-white shadow-md">
                <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center">
                            <!-- LOGO in Header -->
                            <img src="logo.png" alt="Best Cement Logo" class="w-10 h-10">
                            <span class="text-xl font-bold text-gray-800 ml-3">Best Cement IT Asset Portal</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="welcome-user" class="text-gray-600 hidden sm:block"></span>
                            <button id="user-manage-btn" class="admin-only hidden items-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 shadow-sm">
                                <i class="fas fa-users-cog mr-2"></i>User Management
                            </button>
                            <button id="logout-btn" class="items-center px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 shadow-sm">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </div>
                </nav>
            </header>

            <!-- Main Content Area --><main id="main-content" class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8 overflow-y-auto">
                
                <div id="main-loading" class="hidden justify-center items-center py-20">
                    <div class="spinner"></div>
                </div>

                <div id="content-wrapper" class="hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Asset Overview</h2>
                        <div id="dashboard-stats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <!-- Stats cards will be injected here by JS --></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">Asset Dashboard</h2>
                            <div class="flex items-center space-x-3">
                                <button id="export-btn" class="flex items-center px-4 py-2 border border-green-600 rounded-lg text-sm font-medium text-green-700 bg-white hover:bg-green-50 shadow-sm transition duration-200">
                                    <i class="fas fa-file-excel mr-2"></i>Export to CSV/Excel
                                </button>
                                <button id="add-asset-btn" class="flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 shadow-sm transition duration-200">
                                    <i class="fas fa-plus mr-2"></i>Add New Asset
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="search-input" class="form-input w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Search by name, asset no, serial no, make, employee...">
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset No.</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Make/Model</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial No.</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee Code</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CUG Mobile</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designation</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Added</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="asset-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be injected by JS --></tbody>
                            </table>
                            <div id="no-assets-msg" class="text-center py-10 text-gray-500 hidden">
                                <i class="fas fa-box-open text-4xl mb-4"></i>
                                <p>No assets found. Click "Add New Asset" to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Footer --><footer class="text-center py-4 text-sm text-gray-500 bg-gray-200">
                This webapp is developed by IT Dept, Best Cement
            </footer>
        </div>
    </div>

    <!-- Asset Modal (Add/Edit) --><div id="asset-modal" class="hidden fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form id="asset-form">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 max-h-[80vh] overflow-y-auto">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                <i class="fas fa-laptop-medical text-blue-600"></i>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="asset-modal-title">Add New Asset</h3>
                                <div class="mt-4 space-y-4">
                                    <input type="hidden" id="asset-id">
                                    
                                    <div>
                                        <label for="asset-prefix-select" class="block text-sm font-medium text-gray-700 required-label">Asset Number</label>
                                        <div class="mt-1 flex rounded-md shadow-sm">
                                            <select id="asset-prefix-select" class="form-select rounded-l-md border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" style="max-width: 150px;">
                                                <option value="JUD/IT ASSET/">JUD/IT ASSET/</option>
                                                <option value="JSB/IT ASSET/">JSB/IT ASSET/</option>
                                                <option value="other">Other...</option>
                                            </select>
                                            <input type="text" id="asset-number-input" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md form-input border-gray-300" placeholder="001" pattern="\d*" title="Only numbers are allowed" required>
                                        </div>
                                        <input type="text" id="asset-prefix-other" class="hidden mt-2 form-input w-full border border-gray-300 rounded-md shadow-sm" placeholder="Enter custom prefix (e.g., ABC/IT ASSET/)">
                                    </div>

                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="asset-category" class="block text-sm font-medium text-gray-700 required-label">Category</label>
                                            <select id="asset-category" class="mt-1 form-select w-full border border-gray-300 rounded-md shadow-sm" required>
                                                <option value="">Select Category</option>
                                                <option value="Laptop">Laptop</option>
                                                <option value="Desktop">Desktop</option>
                                                <option value="Printer">Printer</option>
                                                <option value="Data Card">Data Card</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="asset-name" class="block text-sm font-medium text-gray-700 required-label">Asset Name</label>
                                            <input type="text" id="asset-name" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Dell XPS 15" required>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="asset-make" class="block text-sm font-medium text-gray-700">Make/Model</label>
                                            <input type="text" id="asset-make" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Dell / Latitude 7490">
                                        </div>
                                        <div>
                                            <label for="asset-serial" class="block text-sm font-medium text-gray-700">Serial No.</label>
                                            <input type="text" id="asset-serial" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm" placeholder="e.g., ABC123XYZ">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="asset-status" class="block text-sm font-medium text-gray-700 required-label">Status</label>
                                        <select id="asset-status" class="mt-1 form-select w-full border border-gray-300 rounded-md shadow-sm" required>
                                            <option value="In Stock">In Stock</option>
                                            <option value="Issued">Issued</option>
                                        </select>
                                    </div>

                                    <div id="issued-to-fields" class="hidden space-y-4 p-4 border border-gray-200 rounded-md">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div>
                                                <label for="employee-name" class="block text-sm font-medium text-gray-700 required-label">Employee Name</label>
                                                <input type="text" id="employee-name" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm">
                                            </div>
                                            <div>
                                                <label for="employee-code" class="block text-sm font-medium text-gray-700 required-label">Employee Code</label>
                                                <input type="tel" id="employee-code" pattern="[0-9]*" title="Please enter only numbers." class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="cug-mobile" class="block text-sm font-medium text-gray-700">CUG Mobile Number</label>
                                        <input type="tel" id="cug-mobile" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm">
                                    </div>
                                    
                                    <div>
                                        <label for="department" class="block text-sm font-medium text-gray-700">Department</label>
                                        <input type="text" id="department" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm">
                                    </div>
                                    
                                    <div>
                                        <label for="designation" class="block text-sm font-medium text-gray-700">Designation</label>
                                        <input type="text" id="designation" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm">
                                    </div>
                                    
                                    <div>
                                        <label for="location" class="block text-sm font-medium text-gray-700 required-label">Location</label>
                                        <select id="location" class="mt-1 form-select w-full border border-gray-300 rounded-md shadow-sm" required>
                                            <option value="HO">HO</option>
                                            <option value="JUD Plant">JUD Plant</option>
                                            <option value="JSB Plant">JSB Plant</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="date" class="block text-sm font-medium text-gray-700 required-label">Date</label>
                                        <input type="date" id="date" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                            Save Asset
                        </button>
                        <button type="button" id="cancel-asset-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Management Modal (Admin Only) --><div id="user-modal" class="hidden fixed z-20 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-users-cog text-indigo-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">User Management</h3>
                            <div class="mt-4 flex flex-col md:flex-row gap-6">
                                
                                <div class="w-full md:w-1/2">
                                    <h4 class="font-semibold text-gray-700" id="user-form-title">Add New User</h4>
                                    <form id="user-form" class="space-y-4 mt-2">
                                        <input type="hidden" id="user-id">
                                        <div>
                                            <label for="user-username" class="block text-sm font-medium text-gray-700 required-label">Username</label>
                                            <input type="text" id="user-username" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm" required>
                                        </div>
                                        <div>
                                            <label for="user-password" class="block text-sm font-medium text-gray-700 required-label">Password</label>
                                            <input type="password" id="user-password" class="mt-1 form-input w-full border border-gray-300 rounded-md shadow-sm" placeholder="Set new or change existing" required>
                                        </div>
                                        <div>
                                            <label for="user-role" class="block text-sm font-medium text-gray-700 required-label">Role</label>
                                            <select id="user-role" class="mt-1 form-select w-full border border-gray-300 rounded-md shadow-sm" required>
                                                <option value="user">User</option>
                                                <option value="admin">Admin (Sub-Admin)</option>
                                            </select>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button type="submit" class="flex-1 inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:text-sm">
                                                Save User
                                            </button>
                                            <button type="button" id="cancel-user-edit-btn" class="hidden flex-1 inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:text-sm">
                                                Cancel Edit
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <div class="w-full md:w-1/2">
                                    <h4 class="font-semibold text-gray-700">Existing Users</h4>
                                    <div id="user-list-container" class="mt-2 space-y-2 max-h-60 overflow-y-auto pr-2">
                                        <!-- User list items injected by JS --></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-user-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Handover Modal --><div id="print-modal" class="hidden fixed z-30 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            
            <!-- Modal panel -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div id="print-modal-content" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                
                <!-- This is the printable area, styled like your PDF -->
                <div id="printable-handover-form" class="p-8 print-no-shadow">
                    <!-- Header -->
                    <div class="flex justify-between items-start border-b-2 border-gray-200 pb-4">
                        <div>
                            <img src="logo.png" alt="Best Cement Logo" class="h-16">
                            <p class="text-sm font-bold text-gray-700">Jaandar cement... Shaandar Jod</p>
                        </div>
                        <div class="text-right">
                            <h2 class="text-2xl font-bold text-gray-800">Laptop & Desktop Handover</h2>
                            <p class="text-sm text-gray-600">Department: IT Infrastructure</p>
                        </div>
                    </div>
                    
                    <!-- Address & Date -->
                    <div class="flex justify-between items-start mt-6 text-sm">
                        <div>
                            <p class="font-bold">Best Cement</p>
                            <p class="text-gray-600">Monal Tower, 6th Floor, GS Road, Swaraj Nagar,</p>
                            <p class="text-gray-600">Sorumotoria, Guwahati - 781006</p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-600">Date: <span id="print-date" class="font-medium text-gray-900"></span></p>
                        </div>
                    </div>

                    <!-- Employee Details -->
                    <div class="mt-8 border border-gray-300 rounded-lg p-4 print-avoid-break">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-500">Employee Name</label>
                                <p id="print-employee-name" class="font-semibold text-gray-900"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-500">Employee ID</label>
                                <p id="print-employee-id" class="font-semibold text-gray-900"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-500">Department</label>
                                <p id="print-department" class="font-semibold text-gray-900"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-500">Location</label>
                                <p id="print-location" class="font-semibold text-gray-900"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Asset Table -->
                    <div class="mt-6 print-avoid-break">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Asset Details</h4>
                        <table class="min-w-full border border-gray-300">
                            <thead class="bg-gray-100 border-b border-gray-300">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 border-r border-gray-300">Sl No.</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 border-r border-gray-300">Asset Make/Model</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 border-r border-gray-300">Asset S/L</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Asset TAG</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white">
                                <tr class="border-t border-gray-300">
                                    <td class="px-4 py-2 text-sm text-gray-800 border-r border-gray-300">1</td>
                                    <td id="print-asset-make" class="px-4 py-2 text-sm text-gray-800 border-r border-gray-300"></td>
                                    <td id="print-asset-serial" class="px-4 py-2 text-sm text-gray-800 border-r border-gray-300"></td>
                                    <td id="print-asset-tag" class="px-4 py-2 text-sm text-gray-800"></td>
                                </tr>
                                <!-- Add more rows here if needed, e.g., for multiple assets -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Notes -->
                    <div class="mt-6 print-avoid-break">
                        <label class="text-sm text-gray-500">Notes:</label>
                        <div id="print-notes" class="w-full h-20 border border-gray-300 rounded-lg p-2 text-sm text-gray-600">
                            <!-- You can add a notes field in your asset modal if you want to populate this -->
                        </div>
                    </div>

                    <!-- Signatures -->
                    <div class="mt-20 flex justify-between text-center print-avoid-break">
                        <div>
                            <p class="border-t border-gray-400 pt-2 px-12 text-sm font-medium text-gray-800">User Signature</p>
                        </div>
                        <div>
                            <p class="border-t border-gray-400 pt-2 px-12 text-sm font-medium text-gray-800">Signature (IT Dept)</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Buttons (Hidden on Print) -->
                <div id="print-modal-buttons" class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="print-handover-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                    <button type="button" id="cancel-print-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- Custom Alert/Toast --><div id="toast" class="hidden fixed top-5 right-5 z-30 px-5 py-3 rounded-lg shadow-xl text-white">
        <span id="toast-message"></span>
    </div>


    <script>
        // --- API & STATE ---
        
        // This is the correct, final URL for your Render backend
        const API_URL = 'https://asset-app-backend-2tgc.onrender.com';
        
        const CATEGORIES = ['Laptop', 'Desktop', 'Printer', 'Data Card', 'Other'];

        let state = {
            currentUser: null,
            assets: [],
            users: [],
            editingAssetId: null,
            editingUserId: null,
            assetFilter: '',
        };

        // --- DOM ELEMENT SELECTORS ---
        const $ = (selector) => document.querySelector(selector);
        
        const loginView = $('#login-view');
        const loginForm = $('#login-form');
        const loginError = $('#login-error');
        const loginButton = $('#login-button');
        const loginButtonText = $('#login-button-text');
        
        const mainView = $('#main-view');
        const mainContent = $('#main-content');
        const mainLoading = $('#main-loading');
        const contentWrapper = $('#content-wrapper');
        const logoutBtn = $('#logout-btn');
        const welcomeUser = $('#welcome-user');
        
        const dashboardStats = $('#dashboard-stats');
        const assetTableBody = $('#asset-table-body');
        const noAssetsMsg = $('#no-assets-msg');
        const addAssetBtn = $('#add-asset-btn');
        const exportBtn = $('#export-btn');
        const searchInput = $('#search-input');

        // Asset Modal
        const assetModal = $('#asset-modal');
        const assetForm = $('#asset-form');
        const cancelAssetBtn = $('#cancel-asset-btn');
        const assetModalTitle = $('#asset-modal-title');
        const assetStatus = $('#asset-status');
        const issuedToFields = $('#issued-to-fields');
        const employeeName = $('#employee-name');
        const employeeCode = $('#employee-code');
        const assetNumberInput = $('#asset-number-input');
        const assetPrefixSelect = $('#asset-prefix-select');
        const assetPrefixOther = $('#asset-prefix-other');

        // User Modal
        const userManageBtn = $('#user-manage-btn');
        const userModal = $('#user-modal');
        const closeUserModalBtn = $('#close-user-modal-btn');
        const userListContainer = $('#user-list-container');
        const userForm = $('#user-form');
        const userFormTitle = $('#user-form-title');
        const cancelUserEditBtn = $('#cancel-user-edit-btn');

        // Print Modal
        const printModal = $('#print-modal');
        const cancelPrintBtn = $('#cancel-print-btn');
        const printHandoverBtn = $('#print-handover-btn');
        
        const toast = $('#toast');
        const toastMessage = $('#toast-message');

        // --- CORE FUNCTIONS ---

        /**
         * Initialize the application on page load.
         */
        function init() {
            checkPersistedLogin();
            
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Asset Listeners
            addAssetBtn.addEventListener('click', showAssetModal);
            cancelAssetBtn.addEventListener('click', hideAssetModal);
            assetForm.addEventListener('submit', handleAssetFormSubmit);
            exportBtn.addEventListener('click', exportToCSV);
            searchInput.addEventListener('input', (e) => {
                state.assetFilter = e.target.value.toLowerCase();
                renderAssetTable();
            });
            assetStatus.addEventListener('change', (e) => toggleIssuedFields(e.target.value));
            assetPrefixSelect.addEventListener('change', (e) => togglePrefixOther(e.target.value));
            
            $('#employee-code').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            // Admin Listeners
            userManageBtn.addEventListener('click', showUserModal);
            closeUserModalBtn.addEventListener('click', hideUserModal);
            userForm.addEventListener('submit', handleUserFormSubmit);
            cancelUserEditBtn.addEventListener('click', resetUserForm);

            // Print Modal Listeners
            cancelPrintBtn.addEventListener('click', hidePrintModal);
            printHandoverBtn.addEventListener('click', printHandoverForm);

            // Dynamic listeners for table buttons (event delegation)
            assetTableBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-asset-btn');
                const deleteBtn = e.target.closest('.delete-asset-btn');
                const printBtn = e.target.closest('.print-asset-btn');
                
                if (editBtn) {
                    const id = parseInt(editBtn.dataset.id);
                    handleEditAsset(id);
                }
                if (deleteBtn) {
                    const id = parseInt(deleteBtn.dataset.id);
                    handleDeleteAsset(id);
                }
                if (printBtn) {
                    const id = parseInt(printBtn.dataset.id);
                    showPrintModal(id);
                }
            });
            
            userListContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-user-btn');
                const deleteBtn = e.target.closest('.delete-user-btn');
                
                if (editBtn) {
                    const id = parseInt(editBtn.dataset.id);
                    handleEditUser(id);
                }
                if (deleteBtn) {
                    const id = parseInt(deleteBtn.dataset.id);
                    handleDeleteUser(id);
                }
            });
        }

        /**
         * Controls which view (Login or Main App) is visible.
         */
        function renderUI() {
            if (state.currentUser) {
                // User is logged in
                loginView.classList.add('hidden');
                mainView.classList.remove('hidden');
                mainView.classList.add('flex', 'flex-col');
                welcomeUser.textContent = `Welcome, ${state.currentUser.username}!`;
                
                if (state.currentUser.role === 'admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                } else {
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                }
                renderDashboardStats();
                renderAssetTable();
            } else {
                // User is logged out
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
                mainView.classList.remove('flex', 'flex-col');
                loginError.classList.add('hidden');
                loginError.textContent = '';
                loginForm.reset();
            }
        }
        
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function setLoginLoading(isLoading) {
            loginButton.disabled = isLoading;
            loginButtonText.textContent = isLoading ? 'Signing In...' : 'Sign In';
            loginButton.classList.toggle('opacity-75', isLoading);
        }

        function setMainLoading(isLoading) {
             if (isLoading) {
                mainLoading.classList.remove('hidden');
                mainLoading.classList.add('flex');
                contentWrapper.classList.add('hidden');
            } else {
                mainLoading.classList.add('hidden');
                mainLoading.classList.remove('flex');
                contentWrapper.classList.remove('hidden');
            }
        }

        // --- AUTHENTICATION & DATA LOADING ---

        async function checkPersistedLogin() {
            const persistedUser = localStorage.getItem('currentUser');
            if (persistedUser) {
                try {
                    state.currentUser = JSON.parse(persistedUser);
                    setMainLoading(true);
                    await loadInitialData();
                    renderUI();
                    setMainLoading(false);
                    showToast(`Welcome back, ${state.currentUser.username}!`);
                } catch (e) {
                    localStorage.removeItem('currentUser');
                    state.currentUser = null;
                    renderUI();
                }
            } else {
                renderUI();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            setLoginLoading(true);
            loginError.classList.add('hidden');
            
            const username = $('#username').value;
            const password = $('#password').value;
            
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const user = await response.json();
                    state.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    await loadInitialData(); 
                    renderUI(); 
                    showToast(`Welcome, ${user.username}!`);
                } else {
                    const err = await response.json();
                    loginError.textContent = err.error || 'Invalid username or password.';
                    loginError.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Login fetch error:', err);
                loginError.textContent = 'Cannot connect to server. Is it running?';
                loginError.classList.remove('hidden');
            } finally {
                setLoginLoading(false);
            }
        }

        async function loadInitialData() {
            try {
                const [assetsRes, usersRes] = await Promise.all([
                    fetch(`${API_URL}/api/assets`),
                    state.currentUser.role === 'admin' ? fetch(`${API_URL}/api/users`) : Promise.resolve(null)
                ]);

                if (!assetsRes.ok) throw new Error('Failed to load assets');
                
                state.assets = await assetsRes.json();
                
                if (usersRes && usersRes.ok) {
                    state.users = await usersRes.json();
                } else {
                    state.users = [];
                }
                
                state.assets.sort((a, b) => a.id - b.id);
                state.users.sort((a, b) => a.id - b.id);

            } catch (err) {
                console.error('Data loading error:', err);
                showToast('Error loading data from database.', true);
                handleLogout();
            }
        }

        function handleLogout() {
            const username = state.currentUser ? state.currentUser.username : 'User';
            state.currentUser = null;
            state.assets = [];
            state.users = [];
            localStorage.removeItem('currentUser');
            renderUI();
            showToast(`User ${username} logged out.`);
        }
        
        // --- DASHBOARD FUNCTION ---

        function renderDashboardStats() {
            dashboardStats.innerHTML = '';
            
            let totalStock = 0;
            let totalIssued = 0;
            const assets = state.assets; 

            CATEGORIES.forEach(category => {
                const stock = assets.filter(a => a.category === category && a.status === 'In Stock').length;
                const issued = assets.filter(a => a.category === category && a.status === 'Issued').length;
                
                totalStock += stock;
                totalIssued += issued;

                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <p class="text-sm font-medium text-gray-500">${category}</p>
                    <p class="text-2xl font-bold text-gray-900">${stock + issued}</p>
                    <div class="text-xs">
                        <span class="text-green-600 font-medium">In Stock: ${stock}</span> | 
                        <span class="text-blue-600 font-medium">Issued: ${issued}</span>
                    </div>
                `;
                dashboardStats.appendChild(card);
            });
            
            const totalCard = document.createElement('div');
            totalCard.className = 'stat-card col-span-2 md:col-span-1 lg:col-auto bg-gray-800 text-white';
            totalCard.innerHTML = `
                <p class="text-sm font-medium text-gray-300">Total Assets</p>
                <p class="text-2xl font-bold text-white">${totalStock + totalIssued}</p>
                <div class="text-xs">
                    <span class="text-green-400 font-medium">Stock: ${totalStock}</span> | 
                    <span class="text-blue-400 font-medium">Issued: ${totalIssued}</span>
                </div>
            `;
            dashboardStats.prepend(totalCard);
        }

        // --- ASSET MANAGEMENT FUNCTIONS ---

        function renderAssetTable() {
            assetTableBody.innerHTML = '';
            
            const filteredAssets = state.assets.filter(asset => {
                const fullAssetNumber = `${asset.assetprefix || ''}${asset.assetnumber}`.toLowerCase();
                const assetName = (asset.assetname || '').toLowerCase();
                const assetMake = (asset.assetmake || '').toLowerCase();
                const assetSerial = (asset.assetserial || '').toLowerCase();
                const department = (asset.department || '').toLowerCase();
                const employeeName = (asset.employeename || '').toLowerCase();
                const employeeCode = (asset.employeecode || '').toLowerCase();
                const location = (asset.location || '').toLowerCase(); // Search location
                
                return (
                    assetName.includes(state.assetFilter) ||
                    fullAssetNumber.includes(state.assetFilter) ||
                    assetMake.includes(state.assetFilter) ||
                    assetSerial.includes(state.assetFilter) ||
                    department.includes(state.assetFilter) ||
                    employeeName.includes(state.assetFilter) ||
                    employeeCode.includes(state.assetFilter) ||
                    location.includes(state.assetFilter) // Search location
                );
            });

            if (filteredAssets.length === 0) {
                noAssetsMsg.classList.remove('hidden');
                return;
            }
            
            noAssetsMsg.classList.add('hidden');
            
            filteredAssets.forEach(asset => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                const displayDate = asset.date ? asset.date.split('T')[0] : 'N/A';
                const isIssued = asset.status === 'Issued';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${asset.assetprefix}${asset.assetnumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${asset.assetname}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.assetmake || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.assetserial || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isIssued ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${asset.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.employeename || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.employeecode || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.cugmobile || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.department || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.designation || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.location || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button class="edit-asset-btn text-blue-600 hover:text-blue-900" data-id="${asset.id}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${state.currentUser.username === 'admin' ? 
                        `<button class="delete-asset-btn text-red-600 hover:text-red-900" data-id="${asset.id}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                        
                        ${isIssued ? 
                        `<button class="print-asset-btn text-gray-600 hover:text-gray-900" data-id="${asset.id}" title="Print Handover Form">
                            <i class="fas fa-print"></i>
                        </button>` : ''}
                    </td>
                `;
                assetTableBody.appendChild(tr);
            });
        }

        function toggleIssuedFields(status) {
            if (status === 'Issued') {
                issuedToFields.classList.remove('hidden');
                employeeName.required = true;
                employeeCode.required = true;
            } else {
                issuedToFields.classList.add('hidden');
                employeeName.required = false;
                employeeCode.required = false;
                employeeName.value = '';
                employeeCode.value = '';
            }
        }
        
        function togglePrefixOther(value) {
            if (value === 'other') {
                assetPrefixOther.classList.remove('hidden');
                assetPrefixOther.required = true;
            } else {
                assetPrefixOther.classList.add('hidden');
                assetPrefixOther.required = false;
                assetPrefixOther.value = '';
            }
        }

        function showAssetModal() {
            assetModal.classList.remove('hidden');
            toggleIssuedFields(assetStatus.value);
            togglePrefixOther(assetPrefixSelect.value);
        }

        function hideAssetModal() {
            assetModal.classList.add('hidden');
            assetForm.reset();
            state.editingAssetId = null;
            assetModalTitle.textContent = 'Add New Asset';
            toggleIssuedFields('In Stock');
            togglePrefixOther('JUD/IT ASSET/');
        }

        async function handleAssetFormSubmit(e) {
            e.preventDefault();
            
            const status = $('#asset-status').value;
            const empName = $('#employee-name').value;
            const empCode = $('#employee-code').value;

            if (status === 'Issued' && (!empName || !empCode)) {
                showToast('Employee Name and Code are required for "Issued" assets.', true);
                return;
            }
            
            let assetPrefix = assetPrefixSelect.value;
            if (assetPrefix === 'other') {
                assetPrefix = $('#asset-prefix-other').value;
                if (!assetPrefix) {
                    showToast('Custom prefix is required when "Other" is selected.', true);
                    return;
                }
            }
            
            const assetData = {
                assetPrefix: assetPrefix,
                assetNumber: $('#asset-number-input').value,
                assetName: $('#asset-name').value,
                category: $('#asset-category').value,
                assetMake: $('#asset-make').value,
                assetSerial: $('#asset-serial').value,
                status: status,
                employeeName: status === 'Issued' ? empName : '',
                employeeCode: status === 'Issued' ? empCode : '',
                cugMobile: $('#cug-mobile').value,
                department: $('#department').value,
                designation: $('#designation').value,
                location: $('#location').value,
                date: $('#date').value,
            };

            const isEditing = !!state.editingAssetId;
            const url = isEditing ? `${API_URL}/api/assets/${state.editingAssetId}` : `${API_URL}/api/assets`;
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assetData)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to save asset');
                }
                
                const savedAsset = await response.json();
                
                if (isEditing) {
                    const index = state.assets.findIndex(a => a.id === state.editingAssetId);
                    if (index !== -1) {
                        state.assets[index] = savedAsset;
                    }
                } else {
                    state.assets.push(savedAsset);
                }
                state.assets.sort((a, b) => a.id - b.id);
                
                showToast(isEditing ? 'Asset updated successfully!' : 'Asset added successfully!');
                hideAssetModal();
                renderUI();
                
            } catch (err) {
                console.error('Save asset error:', err);
                showToast(`Error: ${err.message}`, true);
            }
        }

        function handleEditAsset(id) {
            const asset = state.assets.find(a => a.id === id);
            if (!asset) return;
            
            state.editingAssetId = id;
            assetModalTitle.textContent = 'Edit Asset';
            
            $('#asset-id').value = asset.id;
            assetNumberInput.value = asset.assetnumber;
            $('#asset-name').value = asset.assetname;
            $('#asset-category').value = asset.category;
            $('#asset-make').value = asset.assetmake;
            $('#asset-serial').value = asset.assetserial;
            assetStatus.value = asset.status;
            employeeName.value = asset.employeename;
            employeeCode.value = asset.employeecode;
            $('#cug-mobile').value = asset.cugmobile;
            $('#department').value = asset.department;
            $('#designation').value = asset.designation;
            $('#location').value = asset.location || 'HO';
            $('#date').value = asset.date ? asset.date.split('T')[0] : '';
            
            const standardPrefixes = ['JUD/IT ASSET/', 'JSB/IT ASSET/'];
            if (standardPrefixes.includes(asset.assetprefix)) {
                assetPrefixSelect.value = asset.assetprefix;
                togglePrefixOther(asset.assetprefix);
            } else {
                assetPrefixSelect.value = 'other';
                assetPrefixOther.value = asset.assetprefix || '';
                togglePrefixOther('other');
            }
            
            toggleIssuedFields(asset.status);
            showAssetModal();
        }

        async function handleDeleteAsset(id) {
            if (state.currentUser.username !== 'admin') {
                showToast('You do not have permission to delete assets.', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/assets/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                     const err = await response.json();
                    throw new Error(err.error || 'Failed to delete asset');
                }

                state.assets = state.assets.filter(a => a.id !== id);
                showToast('Asset deleted.', true);
                renderUI();

            } catch (err) {
                console.error('Delete asset error:', err);
                showToast(`Error: ${err.message}`, true);
            }
        }

        function exportToCSV() {
            if (state.assets.length === 0) {
                showToast('No assets to export.', true);
                return;
            }

            const headers = ['AssetNumber', 'Category', 'AssetName', 'MakeModel', 'SerialNo', 'Status', 'EmployeeName', 'EmployeeCode', 'CUGMobile', 'Department', 'Designation', 'Location', 'Date'];
            
            const rows = state.assets.map(asset => 
                [
                    `"${asset.assetprefix}${asset.assetnumber}"`, 
                    `"${asset.category}"`,
                    `"${asset.assetname}"`,
                    `"${asset.assetmake || ''}"`,
                    `"${asset.assetserial || ''}"`,
                    `"${asset.status}"`,
                    `"${asset.employeename || ''}"`,
                    `"${asset.employeecode || ''}"`,
                    `"${asset.cugmobile || ''}"`,
                    `"${asset.department || ''}"`,
                    `"${asset.designation || ''}"`,
                    `"${asset.location || ''}"`,
                    `"${asset.date ? asset.date.split('T')[0] : ''}"`
                ].join(',')
            );
            
            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'best_cement_it_assets.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Assets exported successfully!');
        }
        
        // --- PRINT HANDOVER FUNCTIONS ---

        /**
         * Finds the asset data and populates the print modal.
         */
        function showPrintModal(id) {
            const asset = state.assets.find(a => a.id === id);
            if (!asset) {
                showToast('Could not find asset data to print.', true);
                return;
            }

            // Populate the modal fields
            $('#print-date').textContent = asset.date ? asset.date.split('T')[0] : 'N/A';
            $('#print-employee-name').textContent = asset.employeename || 'N/A';
            $('#print-employee-id').textContent = asset.employeecode || 'N/A';
            $('#print-department').textContent = asset.department || 'N/A';
            $('#print-location').textContent = asset.location || 'N/A';

            $('#print-asset-make').textContent = asset.assetmake || 'N/A';
            $('#print-asset-serial').textContent = asset.assetserial || 'N/A';
            $('#print-asset-tag').textContent = `${asset.assetprefix}${asset.assetnumber}`;
            
            // Show the modal
            printModal.classList.remove('hidden');
        }

        /**
         * Hides the print modal.
         */
        function hidePrintModal() {
            printModal.classList.add('hidden');
        }
        
        /**
         * Triggers the browser's print dialog.
         */
        function printHandoverForm() {
            window.print();
        }


        // --- USER MANAGEMENT FUNCTIONS (ADMIN) ---

        function renderUserList() {
            userListContainer.innerHTML = '';
            
            if (state.users.length === 0) {
                userListContainer.innerHTML = '<p class="text-gray-500">No users found.</p>';
                return;
            }
            
            state.users.forEach(user => {
                const isCurrentUser = user.id === state.currentUser.id;
                const isMainAdmin = user.username === 'admin';
                
                const userEl = document.createElement('div');
                userEl.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                userEl.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${user.username} ${isCurrentUser ? '(You)' : ''}</p>
                        <span class="text-xs font-medium ${user.role === 'admin' ? 'text-indigo-600 bg-indigo-100' : 'text-gray-600 bg-gray-200'} px-2 py-0.5 rounded-full">${user.role}</span>
                    </div>
                    <div class="space-x-2">
                        <button class="edit-user-btn text-blue-600 hover:text-blue-900" data-id="${user.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${!isMainAdmin ?
                        `<button class="delete-user-btn text-red-600 hover:text-red-900" data-id="${user.id}">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </div>
                `;
                userListContainer.appendChild(userEl);
            });
        }
        
        function showUserModal() {
            if (state.currentUser.role !== 'admin') return;
            renderUserList();
            resetUserForm();
            userModal.classList.remove('hidden');
        }

        function hideUserModal() {
            userModal.classList.add('hidden');
        }
        
        function resetUserForm() {
            userForm.reset();
            state.editingUserId = null;
            userFormTitle.textContent = 'Add New User';
            cancelUserEditBtn.classList.add('hidden');
            $('#user-username').disabled = false;
        }
        
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            
            const username = $('#user-username').value;
            const password = $('#user-password').value;
            const role = $('#user-role').value;
            
            if (!username || !role) {
                showToast('Username and Role are required.', true);
                return;
            }
            
            const isEditing = !!state.editingUserId;
            let url = `${API_URL}/api/users`;
            let method = 'POST';
            let body = { username, password, role };

            if (isEditing) {
                url = `${API_URL}/api/users/${state.editingUserId}`;
                method = 'PUT';
                body = { password, role }; 
                if (!password) {
                    delete body.password;
                }
            } else if (!password) {
                showToast('Password is required for new users.', true);
                return;
            }
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to save user');
                }
                
                const savedUser = await response.json();

                if (isEditing) {
                    const index = state.users.findIndex(u => u.id === state.editingUserId);
                    if (index !== -1) {
                        state.users[index] = { ...state.users[index], ...savedUser };
                    }
                } else {
                    state.users.push(savedUser);
                    // Data.json()... // REMOVED THIS LINE
                }
                state.users.sort((a, b) => a.id - b.id);
                
                showToast(isEditing ? 'User updated successfully!' : 'User created successfully!');
                renderUserList();
                resetUserForm();

            } catch (err) {
                console.error('Save user error:', err);
                showToast(`Error: ${err.message}`, true);
            }
        }
        
        function handleEditUser(id) {
            const user = state.users.find(u => u.id === id);
            if (!user) return;

            state.editingUserId = id;
            userFormTitle.textContent = 'Edit User';
            $('#user-id').value = user.id;
            $('#user-username').value = user.username;
            $('#user-username').disabled = true;
            $('#user-password').value = '';
            $('#user-password').placeholder = 'Set new password (optional)';
            $('#user-password').required = false;
            $('#user-role').value = user.role;
            
            cancelUserEditBtn.classList.remove('hidden');
        }
        
        async function handleDeleteUser(id) {
            try {
                const response = await fetch(`${API_URL}/api/users/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete user');
                }

                state.users = state.users.filter(u => u.id !== id);
                showToast('User deleted.', true);
                renderUserList();
                resetUserForm();

            } catch (err) {
                console.error('Delete user error:', err);
                showToast(`Error: ${err.message}`, true);
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>

