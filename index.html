<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Asset Management</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. SheetJS (for Excel Export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 3. Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Print-specific styles */
        @media print {
            /* Hide everything except the asset dashboard */
            body > *:not(#app-screen) {
                display: none;
            }
            #app-screen > *:not(.max-w-7xl) {
                 display: none;
            }
            #app-screen nav, 
            #app-screen footer, 
            #admin-panel, 
            #asset-modal, 
            #message-modal, 
            #export-excel-btn, 
            #add-asset-btn {
                display: none !important;
            }

            /* Ensure the asset dashboard takes full width */
            .max-w-7xl {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Remove dashboard styling for print */
            .bg-white.p-6.rounded-xl.shadow-lg {
                background: none !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }
            
            /* Hide the actions column header */
            .print\:hidden {
                display: none !important;
            }
            
            /* Ensure table prints correctly */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
            }
            th, td {
                border: 1px solid #ddd !important;
                padding: 8px !important;
                font-size: 10pt !important;
            }
            thead.bg-gray-50 {
                background: #eee !important;
            }
            
            /* Hide the "No assets" row if it's there */
            #no-assets-row {
                display: none !important;
            }
            
            /* Hide dashboard header */
            .flex.flex-col.md\:flex-row.md\:items-center.md\:justify-between.mb-6 {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Global Loading Spinner -->
    <div id="app-loading" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="mt-4 text-lg font-medium text-gray-700">Loading Application...</span>
        </div>
    </div>

    <!-- Login/Register Screen -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <div id="login-view">
                <h2 class="text-3xl font-bold text-center text-gray-800">IT Asset Login</h2>
                <p class="text-center text-gray-500 mt-2">Welcome back. Please login to continue.</p>
                <form id="login-form" class="mt-8 space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        Sign in
                    </button>
                    <p class="text-center text-sm">
                        <span class="text-gray-600">No account?</span>
                        <button type="button" id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">Create one</button>
                    </p>
                </form>
            </div>
            
            <div id="register-view" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800">Create Account</h2>
                <p class="text-center text-gray-500 mt-2">The first user to register becomes the admin.</p>
                <form id="register-form" class="mt-8 space-y-6">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input id="register-email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input id="register-password" name="password" type="password" autocomplete="new-password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                        Create Account
                    </button>
                    <p class="text-center text-sm">
                        <span class="text-gray-600">Already have an account?</span>
                        <button type="button" id="show-login-btn" class="font-medium text-blue-600 hover:text-blue-500">Sign in</button>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application Screen -->
    <div id="app-screen" class="hidden">
        <nav class="bg-white shadow-md border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                        </svg>
                        <span class="ml-3 text-2xl font-bold text-gray-800">Best Cement IT Asset Tracking App</span>
                    </div>
                    <div class="flex items-center">
                        <div class="flex flex-col items-end mr-4">
                            <span id="user-email-display" class="text-sm font-medium text-gray-700"></span>
                            <span id="user-role-display" class="text-xs font-semibold text-blue-600 uppercase"></span>
                        </div>
                        <button id="logout-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Admin Panel (Conditional) -->
            <div id="admin-panel" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Panel: User Management</h2>
                <p class="text-sm text-gray-600 mb-6">Users who sign up will appear here. You can then assign them new roles.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change Role</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-table" class="bg-white divide-y divide-gray-200">
                            <!-- User rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Asset Dashboard -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Asset Dashboard</h2>
                    <div class="flex space-x-3 mt-4 md:mt-0">
                        <button id="export-excel-btn" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                            Export to Excel
                        </button>
                        <button id="add-asset-btn" class="py-2 px-5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                            Add Asset
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset #</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CUG Mobile</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designation</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider print:hidden">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="asset-list-table" class="bg-white divide-y divide-gray-200">
                            <!-- Asset rows will be injected here -->
                            <tr id="no-assets-row" class="hidden">
                                <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                                    No assets found. Click "Add Asset" to get started.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 mt-4">
            <p class="text-right text-sm text-gray-500">Copyright to iMosleM</p>
        </footer>
    </div>

    <!-- Asset Modal (Add/Edit) -->
    <div id="asset-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-20">
        <div class="relative top-16 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-xl bg-white">
            <form id="asset-form">
                <h3 id="asset-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Add New Asset</h3>
                <input type="hidden" id="asset-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="asset-employee-name" class="block text-sm font-medium text-gray-700">Employee Name</label>
                        <input type="text" id="asset-employee-name" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="asset-number" class="block text-sm font-medium text-gray-700">Asset Number</label>
                        <input type="text" id="asset-number" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="asset-name" class="block text-sm font-medium text-gray-700">Asset Name</label>
                        <input type="text" id="asset-name" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="asset-cug" class="block text-sm font-medium text-gray-700">CUG Mobile Number</label>
                        <input type="number" id="asset-cug" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="asset-department" class="block text-sm font-medium text-gray-700">Department</label>
                        <input type="text" id="asset-department" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="asset-designation" class="block text-sm font-medium text-gray-700">Designation</label>
                        <input type="text" id="asset-designation" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="asset-location" class="block text-sm font-medium text-gray-700">Location</label>
                        <select id="asset-location" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="">Select Location</option>
                            <option value="HO">HO</option>
                            <option value="JUD Plant">JUD Plant</option>
                            <option value="JSB Plant">JSB Plant</option>
                        </select>
                    </div>
                    <div>
                        <label for="asset-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="asset-date" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="flex items-center justify-end mt-8 space-x-4">
                    <button id="close-modal-btn" type="button" class="py-2 px-5 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
                        Cancel
                    </button>
                    <button id="save-asset-btn" type="submit" class="py-2 px-5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        Save Asset
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Message Modal (replaces alert()) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-30">
        <div class="relative top-20 mx-auto p-6 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="text-center">
                <div id="message-modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                    <!-- Icon will be set by JS -->
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-5" id="message-modal-title">Success</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="message-modal-text">
                        Your message here.
                    </op>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="message-modal-close" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- =================================================================== -->
    <!-- JAVASCRIPT & FIREBASE -->
    <!-- =================================================================== -->
    <script type="module">
        // 1. Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc,
            updateDoc,
            deleteDoc,
            collection, 
            query,
            where,
            onSnapshot,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -------------------------------------------------------------------
        // Firebase Configuration
        // -------------------------------------------------------------------
        
        // Use environment-provided Firebase config or a placeholder
        // The error 'auth/api-key-not-valid' occurs if __firebase_config is not
        // available and the placeholder values are used.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY", 
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentUserId = null;
        let currentUserRole = null;
        let allAssets = []; // Local cache for Excel export
        
        // Firestore Collection Paths
        // Use environment-provided App ID or default to project ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-app-id');
        const ASSETS_COLLECTION = `/artifacts/${appId}/public/data/assets`;
        const USER_ROLES_COLLECTION = `/artifacts/${appId}/public/data/userRoles`;

        // DOM Elements
        let appLoading, authScreen, appScreen, loginView, registerView, loginForm, registerForm,
            showLoginBtn, showRegisterBtn, logoutBtn, userEmailDisplay, userRoleDisplay,
            adminPanel, userListTable, assetListTable, noAssetsRow, addAssetBtn, exportExcelBtn,
            assetModal, assetModalTitle, closeModalBtn, assetForm, assetIdField,
            messageModal, messageModalTitle, messageModalText, messageModalIcon, messageModalClose;

        // --- Message Modal Functions ---
        const iconSuccess = `<svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>`;
        const iconError = `<svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>`;

        function showMessage(title, text, isError = false) {
            messageModalTitle.textContent = title;
            messageModalText.textContent = text;
            if (isError) {
                messageModalIcon.innerHTML = iconError;
                messageModalIcon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100";
            } else {
                messageModalIcon.innerHTML = iconSuccess;
                messageModalIcon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100";
            }
            messageModal.classList.remove('hidden');
        }

        // --- Auth State Controller ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                userEmailDisplay.textContent = user.email || user.uid; // Show UID if email is not present

                // Check or create user role
                await checkAndAssignUserRole(user);

                // Update UI
                userRoleDisplay.textContent = currentUserRole;
                authScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                appLoading.classList.add('hidden');
                
                // Show admin panel if role is 'admin'
                if(currentUserRole === 'admin') {
                    adminPanel.classList.remove('hidden');
                    listenForUserRoles();
                } else {
                    adminPanel.classList.add('hidden');
                }
                
                // Start listening for asset data
                listenForAssets();

            } else {
                // User is signed out
                currentUserId = null;
                currentUserRole = null;
                authScreen.classList.add('hidden');
                appScreen.classList.add('hidden');
                appLoading.classList.remove('hidden'); // Show loading instead of auth screen
                
                // Clear old data
                assetListTable.innerHTML = '';
                userListTable.innerHTML = '';
            }
        });
        
        async function checkAndAssignUserRole(user) {
            const userRoleRef = doc(db, USER_ROLES_COLLECTION, user.uid);
            const userRoleSnap = await getDoc(userRoleRef);
            
            if (userRoleSnap.exists()) {
                // User role already exists
                currentUserRole = userRoleSnap.data().role;
            } else {
                // This is a new user, check if they are the first user
                const usersQuery = query(collection(db, USER_ROLES_COLLECTION), where("role", "==", "admin"));
                const adminUsersSnap = await getDocs(usersQuery);
                
                let newRole = 'user';
                if (adminUsersSnap.empty) {
                    // This is the FIRST user. Make them admin.
                    newRole = 'admin';
                    showMessage('Welcome, Admin!', 'As the first user, you have been assigned the Admin role.');
                }
                
                // Create the user role document
                await setDoc(userRoleRef, {
                    email: user.email || user.uid, // Use UID as fallback
                    role: newRole
                });
                currentUserRole = newRole;
            }
        }

        // --- Auth Form Listeners ---
        /* * NOTE: These listeners are attached in DOMContentLoaded, but are here
         * for logical grouping with auth functions.
        */
        
        // --- Asset Functions ---
        function listenForAssets() {
            const assetsQuery = query(collection(db, ASSETS_COLLECTION));
            
            onSnapshot(assetsQuery, (snapshot) => {
                allAssets = []; // Clear local cache
                assetListTable.innerHTML = ''; // Clear table
                
                if (snapshot.empty) {
                    noAssetsRow.classList.remove('hidden');
                    return;
                }
                
                noAssetsRow.classList.add('hidden');
                
                snapshot.forEach((doc) => {
                    const asset = { id: doc.id, ...doc.data() };
                    allAssets.push(asset); // Add to cache for export
                    renderAssetRow(asset);
                });
            }, (error) => {
                console.error("Error listening for assets:", error);
                showMessage('Error', 'Could not load asset data.', true);
            });
        }
        
        function renderAssetRow(asset) {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${asset.employeeName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${asset.number}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${asset.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${asset.cug}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${asset.department}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${asset.designation}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${asset.location}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${asset.date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3 print:hidden">
                    <button data-id="${asset.id}" class="edit-btn text-blue-600 hover:text-blue-900 transition">Edit</button>
                    <button data-id="${asset.id}" class="delete-btn text-red-600 hover:text-red-900 transition">Delete</button>
                </td>
            `;
            assetListTable.appendChild(tr);
        }
        
        // --- Asset Modal & Form ---
        function openAssetModal(asset = null) {
            assetForm.reset();
            if (asset) {
                // Edit Mode
                assetModalTitle.textContent = 'Edit Asset';
                assetIdField.value = asset.id;
                document.getElementById('asset-employee-name').value = asset.employeeName || '';
                document.getElementById('asset-number').value = asset.number || '';
                document.getElementById('asset-name').value = asset.name || '';
                document.getElementById('asset-cug').value = asset.cug || '';
                document.getElementById('asset-department').value = asset.department || '';
                document.getElementById('asset-designation').value = asset.designation || '';
                document.getElementById('asset-location').value = asset.location || '';
                document.getElementById('asset-date').value = asset.date || '';
            } else {
                // Add Mode
                assetModalTitle.textContent = 'Add New Asset';
                assetIdField.value = '';
            }
            assetModal.classList.remove('hidden');
        }
        
        // --- Admin Panel Functions ---
        function listenForUserRoles() {
            const usersQuery = query(collection(db, USER_ROLES_COLLECTION));
            
            onSnapshot(usersQuery, (snapshot) => {
                userListTable.innerHTML = ''; // Clear table
                
                snapshot.forEach((doc) => {
                    const user = { id: doc.id, ...doc.data() };
                    renderUserRow(user);
                });
            }, (error) => {
                console.error("Error listening for users:", error);
                showMessage('Error', 'Could not load user data.', true);
            });
        }
        
        function renderUserRow(user) {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            
            // Prevent admin from changing their own role
            const disabled = (user.id === currentUserId) ? 'disabled' : '';
            
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.email || user.uid}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 uppercase font-semibold">${user.role}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <select data-id="${user.id}" class="role-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" ${disabled}>
                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                        <option value="sub-admin" ${user.role === 'sub-admin' ? 'selected' : ''}>Sub-Admin</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </td>
            `;
            userListTable.appendChild(tr);
        }

        // --- Initial Authentication ---
        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.warn("Signing in anonymously. Auth token not found.");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showMessage('Authentication Failed', 'Could not sign in. ' + error.message, true);
                appLoading.classList.add('hidden');
                authScreen.classList.remove('hidden'); // Show auth as fallback
            }
        }

        // --- Main App Initializer ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign DOM elements now that the DOM is loaded
            appLoading = document.getElementById('app-loading');
            authScreen = document.getElementById('auth-screen');
            appScreen = document.getElementById('app-screen');
            loginView = document.getElementById('login-view');
            registerView = document.getElementById('register-view');
            loginForm = document.getElementById('login-form');
            registerForm = document.getElementById('register-form');
            showLoginBtn = document.getElementById('show-login-btn');
            showRegisterBtn = document.getElementById('show-register-btn');
            logoutBtn = document.getElementById('logout-btn');
            userEmailDisplay = document.getElementById('user-email-display');
            userRoleDisplay = document.getElementById('user-role-display');
            adminPanel = document.getElementById('admin-panel');
            userListTable = document.getElementById('user-list-table');
            assetListTable = document.getElementById('asset-list-table');
            noAssetsRow = document.getElementById('no-assets-row');
            addAssetBtn = document.getElementById('add-asset-btn');
            exportExcelBtn = document.getElementById('export-excel-btn');
            assetModal = document.getElementById('asset-modal');
            assetModalTitle = document.getElementById('asset-modal-title');
            closeModalBtn = document.getElementById('close-modal-btn');
            assetForm = document.getElementById('asset-form');
            assetIdField = document.getElementById('asset-id');
            messageModal = document.getElementById('message-modal');
            messageModalTitle = document.getElementById('message-modal-title');
            messageModalText = document.getElementById('message-modal-text');
            messageModalIcon = document.getElementById('message-modal-icon');
            messageModalClose = document.getElementById('message-modal-close');

            // Attach all event listeners
            messageModalClose.addEventListener('click', () => messageModal.classList.add('hidden'));
            
            showRegisterBtn.addEventListener('click', () => {
                loginView.classList.add('hidden');
                registerView.classList.remove('hidden');
            });
            
            showLoginBtn.addEventListener('click', () => {
                loginView.classList.remove('hidden');
                registerView.classList.add('hidden');
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                appLoading.classList.remove('hidden');
                const email = loginForm['login-email'].value;
                const password = loginForm['login-password'].value;
                
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login error:", error);
                    showMessage('Login Failed', error.message, true);
                    appLoading.classList.add('hidden');
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                appLoading.classList.remove('hidden');
                const email = registerForm['register-email'].value;
                const password = registerForm['register-password'].value;
                
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Registration error:", error);
                    showMessage('Registration Failed', error.message, true);
                    appLoading.classList.add('hidden');
                }
            });
            
            logoutBtn.addEventListener('click', async () => {
                appLoading.classList.remove('hidden');
                await signOut(auth);
                await authenticateUser();
            });

            addAssetBtn.addEventListener('click', () => openAssetModal());
            closeModalBtn.addEventListener('click', () => assetModal.classList.add('hidden'));

            assetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const assetId = assetIdField.value;
                
                const assetData = {
                    employeeName: document.getElementById('asset-employee-name').value,
                    number: document.getElementById('asset-number').value,
                    name: document.getElementById('asset-name').value,
                    cug: document.getElementById('asset-cug').value,
                    department: document.getElementById('asset-department').value,
                    designation: document.getElementById('asset-designation').value,
                    location: document.getElementById('asset-location').value, // <-- FIX: Added this line
                    date: document.getElementById('asset-date').value,
                };
                
                try {
                    if (assetId) {
                        const assetRef = doc(db, ASSETS_COLLECTION, assetId);
                        await updateDoc(assetRef, assetData);
                        showMessage('Success', 'Asset updated successfully.');
                    } else {
                        await addDoc(collection(db, ASSETS_COLLECTION), assetData);
                        showMessage('Success', 'Asset added successfully.');
                    }
                    assetModal.classList.add('hidden');
                    assetForm.reset();
                } catch (error) {
                    console.error("Error saving asset:", error);
                    showMessage('Error', 'Could not save asset.', true);
                }
            });

            assetListTable.addEventListener('click', async (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    const assetId = e.target.dataset.id;
                    const asset = allAssets.find(a => a.id === assetId);
                    if(asset) {
                        openAssetModal(asset);
                    }
                }
                
                if (e.target.classList.contains('delete-btn')) {
                    const assetId = e.target.dataset.id;
                    try {
                        await deleteDoc(doc(db, ASSETS_COLLECTION, assetId));
                        showMessage('Success', 'Asset deleted.');
                    } catch (error) {
                        console.error("Error deleting asset:", error);
                        showMessage('Error', 'Could not delete asset.', true);
                    }
                }
            });

            userListTable.addEventListener('change', async (e) => {
                if (e.target.classList.contains('role-select')) {
                    const targetUserId = e.target.dataset.id;
                    const newRole = e.target.value;
                    
                    if (targetUserId === currentUserId) {
                        showMessage('Action Not Allowed', 'You cannot change your own role.', true);
                        return;
                    }
                    
                    try {
                        const userRoleRef = doc(db, USER_ROLES_COLLECTION, targetUserId);
                        await updateDoc(userRoleRef, {
                            role: newRole
                        });
                        showMessage('Success', `User role updated to ${newRole}.`);
                    } catch (error) {
                        console.error("Error updating role:", error);
                        showMessage('Error', 'Could not update user role.', true);
                    }
                }
            });

            exportExcelBtn.addEventListener('click', () => {
                if (allAssets.length === 0) {
                    showMessage('No Data', 'There is no asset data to export.', true);
                    return;
                }
                
                const exportData = allAssets.map(asset => ({
                    "Employee Name": asset.employeeName,
                    "Asset Number": asset.number,
                    "Asset Name": asset.name,
                    "CUG Mobile": asset.cug,
                    "Department": asset.department,
                    "Designation": asset.designation,
                    "Location": asset.location, // <-- FIX: Added this line
                    "Date": asset.date
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Assets");
                
                XLSX.writeFile(wb, "IT_Asset_Export.xlsx");
            });

            // Start the application
            authenticateUser();
        });

    </script>
</body>
</html>

